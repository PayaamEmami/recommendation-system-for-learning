@page "/feeds"
@page "/feeds/{FeedType}"
@rendermode InteractiveServer
@using Rsl.Web.Services
@using Rsl.Core.Enums
@inject AuthService AuthService
@inject FeedService FeedService
@inject SourceService SourceService
@inject ThemeService ThemeService
@inject NavigationManager Navigation
@implements IDisposable

<PageTitle>@GetPageTitle() - RSL</PageTitle>

<div class="page-container">
    <div class="page-header">
        <h1>@GetPageTitle()</h1>
        <p class="subtitle">Discover and explore learning resources</p>
    </div>

    <div class="feed-filters">
        <a href="/feeds" class="filter-button @(string.IsNullOrEmpty(FeedType) ? "active" : "")">
            All
        </a>
        @foreach (var type in Enum.GetValues<ResourceType>())
        {
            var typeName = type.ToString().ToLower();
            <a href="/feeds/@typeName" class="filter-button @(FeedType?.Equals(typeName, StringComparison.OrdinalIgnoreCase) == true ? "active" : "")">
                @GetResourceTypeDisplay(type)
            </a>
        }
    </div>

    <div class="feed-container">
        @if (_resources == null)
        {
            <p>Loading feed...</p>
        }
        else if (!_resources.Any())
        {
            @if (_sources == null)
            {
                <p>Checking your sources...</p>
            }
            else if (!_sources.Any())
            {
                <div class="empty-state" style="text-align: center; padding: 3rem 1rem;">
                    <h2 style="margin-bottom: 1rem; color: var(--text-primary);">No Sources Yet</h2>
                    <p style="margin-bottom: 0.5rem; color: var(--text-secondary);">
                        Start by adding some learning sources like RSS feeds, YouTube channels, or blogs.
                    </p>
                    <p style="margin-bottom: 2rem; color: var(--text-secondary);">
                        Our system will automatically fetch content daily and show personalized recommendations here.
                    </p>
                    <a href="/sources" class="btn-primary">Add Your First Source</a>
                </div>
            }
            else
            {
                <div class="empty-state" style="text-align: center; padding: 3rem 1rem;">
                    <h2 style="margin-bottom: 1rem; color: var(--text-primary);">Processing Your Sources</h2>
                    <p style="margin-bottom: 0.5rem; color: var(--text-secondary);">
                        You have @_sources.Count source@(_sources.Count == 1 ? "" : "s") configured. Our system is working on fetching and analyzing content.
                    </p>
                    <p style="margin-bottom: 2rem; color: var(--text-secondary);">
                        This process runs automatically every 24 hours. Check back soon for personalized recommendations!
                    </p>
                    <a href="/sources" class="btn-primary">Manage Sources</a>
                </div>
            }
        }
        else
        {
            <div class="resources-list">
                @foreach (var resource in _resources)
                {
                    <div class="resource-card">
                        <div class="resource-header">
                            <span class="resource-type">@GetResourceTypeDisplay(resource.Type)</span>
                            <span class="resource-date">@FormatDate(resource.PublishedAt)</span>
                        </div>
                        <h3 class="resource-title">
                            <a href="@resource.Url" target="_blank">@resource.Title</a>
                        </h3>
                        @if (!string.IsNullOrEmpty(resource.Description))
                        {
                            <p class="resource-description">@resource.Description</p>
                        }
                        <div class="resource-footer">
                            <a href="@resource.Url" target="_blank" class="resource-link">View Resource â†’</a>
                        </div>
                    </div>
                }
            </div>
        }
    </div>
</div>

@code {
    [Parameter]
    public string? FeedType { get; set; }

    private List<ResourceItem>? _resources;
    private List<SourceItem>? _sources;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await ThemeService.InitializeAsync();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        if (!AuthService.CurrentState.IsAuthenticated)
        {
            Navigation.NavigateTo("/login");
            return;
        }

        AuthService.OnAuthStateChanged += HandleAuthStateChanged;
        await LoadFeed();
    }

    protected override async Task OnParametersSetAsync()
    {
        await LoadFeed();
    }

    private async Task LoadFeed()
    {
        ResourceType? type = null;

        if (!string.IsNullOrEmpty(FeedType))
        {
            if (Enum.TryParse<ResourceType>(FeedType, ignoreCase: true, out var parsedType))
            {
                type = parsedType;
            }
        }

        _resources = await FeedService.GetFeedAsync(type);

        // Only check for sources if we have no resources to show appropriate message
        if (!_resources.Any())
        {
            _sources = await SourceService.GetUserSourcesAsync();
        }
    }

    private void HandleAuthStateChanged()
    {
        if (!AuthService.CurrentState.IsAuthenticated)
        {
            Navigation.NavigateTo("/login");
        }
    }

    private string GetPageTitle()
    {
        if (string.IsNullOrEmpty(FeedType))
            return "All Feeds";

        if (Enum.TryParse<ResourceType>(FeedType, ignoreCase: true, out var type))
        {
            return GetResourceTypeDisplay(type);
        }

        return "Feed";
    }

    private static string GetResourceTypeDisplay(ResourceType type)
    {
        return type switch
        {
            ResourceType.Paper => "Papers",
            ResourceType.Video => "Videos",
            ResourceType.BlogPost => "Blogs",
            _ => type.ToString()
        };
    }

    private static string FormatDate(DateTime date)
    {
        var span = DateTime.UtcNow - date;

        if (span.TotalDays < 1)
            return $"{(int)span.TotalHours}h ago";
        if (span.TotalDays < 7)
            return $"{(int)span.TotalDays}d ago";
        if (span.TotalDays < 30)
            return $"{(int)(span.TotalDays / 7)}w ago";

        return date.ToString("MMM d, yyyy");
    }

    public void Dispose()
    {
        AuthService.OnAuthStateChanged -= HandleAuthStateChanged;
    }
}
