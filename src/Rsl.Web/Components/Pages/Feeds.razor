@page "/feeds"
@rendermode InteractiveServer
@using Rsl.Web.Services
@using Rsl.Core.Enums
@using Microsoft.JSInterop
@inject AuthService AuthService
@inject FeedService FeedService
@inject SourceService SourceService
@inject ThemeService ThemeService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@implements IDisposable

<PageTitle>My Feed - RSL</PageTitle>

<div class="page-container">
    <div class="page-header">
        <h1>My Feed</h1>
        <p class="subtitle">Discover and explore learning resources</p>
    </div>

    <div class="feed-container">
        @if (_resources == null)
        {
            <p>Loading feed...</p>
        }
        else if (!_resources.Any())
        {
            @if (_sources == null)
            {
                <p>Checking your sources...</p>
            }
            else if (!_sources.Any())
            {
                <div class="empty-state" style="text-align: center; padding: 3rem 1rem;">
                    <h2 style="margin-bottom: 1rem; color: var(--text-primary);">No Sources Yet</h2>
                    <p style="margin-bottom: 0.5rem; color: var(--text-secondary);">
                        Start by adding some learning sources like RSS feeds, YouTube channels, or blogs.
                    </p>
                    <p style="margin-bottom: 2rem; color: var(--text-secondary);">
                        Our system will automatically fetch content daily and show personalized recommendations here.
                    </p>
                    <a href="/sources" class="btn-primary">Add Your First Source</a>
                </div>
            }
            else
            {
                <div class="empty-state" style="text-align: center; padding: 3rem 1rem;">
                    <h2 style="margin-bottom: 1rem; color: var(--text-primary);">Processing Your Sources</h2>
                    <p style="margin-bottom: 0.5rem; color: var(--text-secondary);">
                        You have @_sources.Count source@(_sources.Count == 1 ? "" : "s") configured. Our system is working on fetching and analyzing content.
                    </p>
                    <p style="margin-bottom: 2rem; color: var(--text-secondary);">
                        This process runs automatically every 24 hours. Check back soon for personalized recommendations!
                    </p>
                    <a href="/sources" class="btn-primary">Manage Sources</a>
                </div>
            }
        }
        else
        {
            <div class="feed-sections">
                @foreach (var type in Enum.GetValues<ResourceType>())
                {
                    var resourcesOfType = _resourcesByType.ContainsKey(type) ? _resourcesByType[type] : new List<ResourceItem>();

                    @if (resourcesOfType.Any())
                    {
                        <div class="feed-section">
                            <h2 class="section-title">@GetResourceTypeDisplay(type)</h2>
                            <div class="resource-table">
                                @foreach (var resource in resourcesOfType)
                                {
                                    <div class="resource-row">
                                        <div class="resource-vote-controls">
                                            <button class="vote-btn vote-up @(GetVoteState(resource.Id) == VoteType.Upvote ? "active" : "")"
                                                    @onclick="() => HandleVote(resource.Id, VoteType.Upvote)"
                                                    disabled="@_votingResourceId.HasValue"
                                                    title="Upvote">
                                                <span class="vote-icon">â–²</span>
                                            </button>
                                            <button class="vote-btn vote-down @(GetVoteState(resource.Id) == VoteType.Downvote ? "active" : "")"
                                                    @onclick="() => HandleVote(resource.Id, VoteType.Downvote)"
                                                    disabled="@_votingResourceId.HasValue"
                                                    title="Downvote">
                                                <span class="vote-icon">â–¼</span>
                                            </button>
                                        </div>
                                        <div class="resource-content">
                                            <div class="resource-meta">
                                                <span class="resource-type-badge">@GetResourceTypeBadge(resource.Type)</span>
                                                <span class="resource-date">@FormatDate(resource.PublishedAt)</span>
                                            </div>
                                            <h3 class="resource-row-title">
                                                <a href="@resource.Url" target="_blank" rel="noopener">@resource.Title</a>
                                            </h3>
                                            @if (!string.IsNullOrEmpty(resource.Description))
                                            {
                                                <p class="resource-row-description">@resource.Description</p>
                                            }
                                        </div>
                                        <div class="resource-actions">
                                            <a href="@resource.Url" target="_blank" rel="noopener" class="resource-open-btn" title="Open resource">
                                                â†—
                                            </a>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                }
            </div>
        }
    </div>
</div>

@code {
    private List<ResourceItem>? _resources;
    private List<SourceItem>? _sources;
    private Dictionary<ResourceType, List<ResourceItem>> _resourcesByType = new();
    private Dictionary<Guid, VoteType> _userVotes = new();
    private Guid? _votingResourceId;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await ThemeService.InitializeAsync();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        if (!AuthService.CurrentState.IsAuthenticated)
        {
            Navigation.NavigateTo("/login");
            return;
        }

        AuthService.OnAuthStateChanged += HandleAuthStateChanged;
        await LoadFeed();
    }

    private async Task LoadFeed()
    {
        _resources = await FeedService.GetFeedAsync(null);

        // Group resources by type
        if (_resources != null && _resources.Any())
        {
            _resourcesByType = _resources
                .GroupBy(r => r.Type)
                .ToDictionary(g => g.Key, g => g.ToList());

            // Load user votes for all resources
            await LoadUserVotes();
        }
        else
        {
            _resourcesByType = new Dictionary<ResourceType, List<ResourceItem>>();
        }

        // Only check for sources if we have no resources to show appropriate message
        if (_resources == null || !_resources.Any())
        {
            _sources = await SourceService.GetUserSourcesAsync();
        }

        StateHasChanged();
    }

    private async Task LoadUserVotes()
    {
        if (_resources == null) return;

        var votes = await FeedService.GetUserVotesAsync();
        _userVotes = votes.ToDictionary(v => v.ResourceId, v => v.VoteType);
    }

    private VoteType? GetVoteState(Guid resourceId)
    {
        return _userVotes.TryGetValue(resourceId, out var voteType) ? voteType : null;
    }

    private async Task HandleVote(Guid resourceId, VoteType voteType)
    {
        if (_votingResourceId.HasValue) return;

        _votingResourceId = resourceId;
        StateHasChanged();

        try
        {
            var currentVote = GetVoteState(resourceId);

            if (currentVote == voteType)
            {
                // Remove vote if clicking the same button
                var success = await FeedService.RemoveVoteAsync(resourceId);
                if (success)
                {
                    _userVotes.Remove(resourceId);
                }
            }
            else
            {
                // Cast or update vote
                var result = await FeedService.VoteAsync(resourceId, voteType);
                if (result != null)
                {
                    _userVotes[resourceId] = result.VoteType;
                }
            }
        }
        finally
        {
            _votingResourceId = null;
            StateHasChanged();
        }
    }

    private void HandleAuthStateChanged()
    {
        if (!AuthService.CurrentState.IsAuthenticated)
        {
            Navigation.NavigateTo("/login");
        }
    }

    private static string GetResourceTypeDisplay(ResourceType type)
    {
        return type switch
        {
            ResourceType.Paper => "Papers",
            ResourceType.Video => "Videos",
            ResourceType.BlogPost => "Blogs",
            _ => type.ToString()
        };
    }

    private static string GetResourceTypeBadge(ResourceType type)
    {
        return type switch
        {
            ResourceType.Paper => "ðŸ“„",
            ResourceType.Video => "ðŸŽ¬",
            ResourceType.BlogPost => "ðŸ“",
            _ => "ðŸ“Ž"
        };
    }

    private static string FormatDate(DateTime date)
    {
        var span = DateTime.UtcNow - date;

        if (span.TotalDays < 1)
            return $"{(int)span.TotalHours}h ago";
        if (span.TotalDays < 7)
            return $"{(int)span.TotalDays}d ago";
        if (span.TotalDays < 30)
            return $"{(int)(span.TotalDays / 7)}w ago";

        return date.ToString("MMM d, yyyy");
    }

    public void Dispose()
    {
        AuthService.OnAuthStateChanged -= HandleAuthStateChanged;
    }
}
