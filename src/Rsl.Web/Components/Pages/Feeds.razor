@page "/feeds"
@rendermode InteractiveServer
@using Rsl.Web.Services
@using Rsl.Core.Enums
@using Microsoft.JSInterop
@inject AuthService AuthService
@inject FeedService FeedService
@inject SourceService SourceService
@inject ThemeService ThemeService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@implements IDisposable

<PageTitle>My Feed - RSL</PageTitle>

<div class="page-container">
    <div class="page-header">
        <h1>My Feed</h1>
        <p class="subtitle">Discover and explore learning resources</p>
    </div>

    <div class="feed-container">
        @if (_resources == null)
        {
            <p>Loading feed...</p>
        }
        else if (!_resources.Any())
        {
            @if (_sources == null)
            {
                <p>Checking your sources...</p>
            }
            else if (!_sources.Any())
            {
                <div class="empty-state" style="text-align: center; padding: 3rem 1rem;">
                    <h2 style="margin-bottom: 1rem; color: var(--text-primary);">No Sources Yet</h2>
                    <p style="margin-bottom: 0.5rem; color: var(--text-secondary);">
                        Start by adding some learning sources like RSS feeds, YouTube channels, or blogs.
                    </p>
                    <p style="margin-bottom: 2rem; color: var(--text-secondary);">
                        Our system will automatically fetch content daily and show personalized recommendations here.
                    </p>
                    <a href="/sources" class="btn-primary">Add Your First Source</a>
                </div>
            }
            else
            {
                <div class="empty-state" style="text-align: center; padding: 3rem 1rem;">
                    <h2 style="margin-bottom: 1rem; color: var(--text-primary);">Processing Your Sources</h2>
                    <p style="margin-bottom: 0.5rem; color: var(--text-secondary);">
                        You have @_sources.Count source@(_sources.Count == 1 ? "" : "s") configured. Our system is working on fetching and analyzing content.
                    </p>
                    <p style="margin-bottom: 2rem; color: var(--text-secondary);">
                        This process runs automatically every 24 hours. Check back soon for personalized recommendations!
                    </p>
                    <a href="/sources" class="btn-primary">Manage Sources</a>
                </div>
            }
        }
        else
        {
            <div class="feed-sections">
                @foreach (var type in Enum.GetValues<ResourceType>())
                {
                    var resourcesOfType = _resourcesByType.ContainsKey(type) ? _resourcesByType[type] : new List<ResourceItem>();

                    @if (resourcesOfType.Any())
                    {
                        <div class="feed-section">
                            <h2 class="section-title">@GetResourceTypeDisplay(type)</h2>
                            <div class="carousel-wrapper">
                                <button class="carousel-nav carousel-nav-left" @onclick="() => ScrollCarouselLeft(type)">
                                    ‹
                                </button>
                                @if (type == ResourceType.Paper)
                                {
                                    <div class="resources-carousel" @ref="_paperCarousel">
                                        @foreach (var resource in resourcesOfType)
                                        {
                                            <div class="resource-card-horizontal">
                                                <div class="resource-header">
                                                    <span class="resource-type">@GetResourceTypeDisplay(resource.Type)</span>
                                                    <span class="resource-date">@FormatDate(resource.PublishedAt)</span>
                                                </div>
                                                <h3 class="resource-title">
                                                    <a href="@resource.Url" target="_blank">@resource.Title</a>
                                                </h3>
                                                @if (!string.IsNullOrEmpty(resource.Description))
                                                {
                                                    <p class="resource-description">@resource.Description</p>
                                                }
                                                <div class="resource-footer">
                                                    <a href="@resource.Url" target="_blank" class="resource-link">View Resource →</a>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                }
                                else if (type == ResourceType.Video)
                                {
                                    <div class="resources-carousel" @ref="_videoCarousel">
                                        @foreach (var resource in resourcesOfType)
                                        {
                                            <div class="resource-card-horizontal">
                                                <div class="resource-header">
                                                    <span class="resource-type">@GetResourceTypeDisplay(resource.Type)</span>
                                                    <span class="resource-date">@FormatDate(resource.PublishedAt)</span>
                                                </div>
                                                <h3 class="resource-title">
                                                    <a href="@resource.Url" target="_blank">@resource.Title</a>
                                                </h3>
                                                @if (!string.IsNullOrEmpty(resource.Description))
                                                {
                                                    <p class="resource-description">@resource.Description</p>
                                                }
                                                <div class="resource-footer">
                                                    <a href="@resource.Url" target="_blank" class="resource-link">View Resource →</a>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                }
                                else if (type == ResourceType.BlogPost)
                                {
                                    <div class="resources-carousel" @ref="_blogPostCarousel">
                                        @foreach (var resource in resourcesOfType)
                                        {
                                            <div class="resource-card-horizontal">
                                                <div class="resource-header">
                                                    <span class="resource-type">@GetResourceTypeDisplay(resource.Type)</span>
                                                    <span class="resource-date">@FormatDate(resource.PublishedAt)</span>
                                                </div>
                                                <h3 class="resource-title">
                                                    <a href="@resource.Url" target="_blank">@resource.Title</a>
                                                </h3>
                                                @if (!string.IsNullOrEmpty(resource.Description))
                                                {
                                                    <p class="resource-description">@resource.Description</p>
                                                }
                                                <div class="resource-footer">
                                                    <a href="@resource.Url" target="_blank" class="resource-link">View Resource →</a>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                }
                                <button class="carousel-nav carousel-nav-right" @onclick="() => ScrollCarouselRight(type)">
                                    ›
                                </button>
                            </div>
                        </div>
                    }
                }
            </div>
        }
    </div>
</div>

@code {
    private List<ResourceItem>? _resources;
    private List<SourceItem>? _sources;
    private Dictionary<ResourceType, List<ResourceItem>> _resourcesByType = new();
    private ElementReference _paperCarousel;
    private ElementReference _videoCarousel;
    private ElementReference _blogPostCarousel;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await ThemeService.InitializeAsync();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        if (!AuthService.CurrentState.IsAuthenticated)
        {
            Navigation.NavigateTo("/login");
            return;
        }

        AuthService.OnAuthStateChanged += HandleAuthStateChanged;
        await LoadFeed();
    }

    private async Task LoadFeed()
    {
        _resources = await FeedService.GetFeedAsync(null);

        // Group resources by type
        if (_resources != null && _resources.Any())
        {
            _resourcesByType = _resources
                .GroupBy(r => r.Type)
                .ToDictionary(g => g.Key, g => g.ToList());
        }
        else
        {
            _resourcesByType = new Dictionary<ResourceType, List<ResourceItem>>();
        }

        // Only check for sources if we have no resources to show appropriate message
        if (_resources == null || !_resources.Any())
        {
            _sources = await SourceService.GetUserSourcesAsync();
        }

        StateHasChanged();
    }

    private void HandleAuthStateChanged()
    {
        if (!AuthService.CurrentState.IsAuthenticated)
        {
            Navigation.NavigateTo("/login");
        }
    }

    private static string GetResourceTypeDisplay(ResourceType type)
    {
        return type switch
        {
            ResourceType.Paper => "Papers",
            ResourceType.Video => "Videos",
            ResourceType.BlogPost => "Blogs",
            _ => type.ToString()
        };
    }

    private static string FormatDate(DateTime date)
    {
        var span = DateTime.UtcNow - date;

        if (span.TotalDays < 1)
            return $"{(int)span.TotalHours}h ago";
        if (span.TotalDays < 7)
            return $"{(int)span.TotalDays}d ago";
        if (span.TotalDays < 30)
            return $"{(int)(span.TotalDays / 7)}w ago";

        return date.ToString("MMM d, yyyy");
    }

    private ElementReference GetCarouselRef(ResourceType type)
    {
        return type switch
        {
            ResourceType.Paper => _paperCarousel,
            ResourceType.Video => _videoCarousel,
            ResourceType.BlogPost => _blogPostCarousel,
            _ => default
        };
    }

    private async Task ScrollCarouselLeft(ResourceType type)
    {
        var carouselRef = GetCarouselRef(type);
        await JSRuntime.InvokeVoidAsync("scrollCarousel", carouselRef, -1);
    }

    private async Task ScrollCarouselRight(ResourceType type)
    {
        var carouselRef = GetCarouselRef(type);
        await JSRuntime.InvokeVoidAsync("scrollCarousel", carouselRef, 1);
    }

    public void Dispose()
    {
        AuthService.OnAuthStateChanged -= HandleAuthStateChanged;
    }
}
